---
title: 打单打印逻辑逻辑重构
date: 2021-07-20 14:12:15
permalink: /pages/1b2ae4/
categories:
  - 项目工具
  - 项目笔记
tags:
  -
---

## 一、全局上的调整

1. 新增`js_v5/trade/v6`文件夹，新重构的逻辑写到这里面
2. 对`js_v5/trade/v6`添加`eslint`
```js
// .eslintignore
!js_v5/trade/v6
# !js_v5/trade/controllers
# js_v5/trade/controllers/*
# !js_v5/trade/controllers/order
# js_v5/trade/controllers/order/*
# !js_v5/trade/controllers/order/index.js
```
3. 对`js_v5/trade/v6`添加简写路径`@trade-v6`，对对`js_v5/trade/*`添加简写路径`@trade`
```json
// jsconfig.json
{
    "compilerOptions": {
        "target": "ES6",
        "baseUrl": "./",
        "paths": {
            "@trade-v5/*": ["js_v5/trade/*"],
            "@trade-v6/*": ["js_v5/trade/v6/*"],
        }
    },
}
```
```js
// webpack.common.js
const config = {
    resolve: {
        alias: {
            '@trade-v5': path.resolve(__dirname, 'js_v5/trade'),
            '@trade-v6': path.resolve(__dirname, 'js_v5/trade/v6'),
        },,
    },
}
```
1. 新增全局变量`TRADE_STORE`
```js
    // .eslintrc
    "globals": {
        "HLG": true,
        "TRADE_STORE": true
    },
```
2. 在入口文件里新增全局变量`HLG.tradeData`
```phtml
<script>
HLG.tradeData = {
    isNewUser: Number(<?php echo $this->new_user; ?>),
    isNewVersion: <?php echo $this->user_version; ?>,
    localShop: <?php echo $this->local_shop; ?>,
    isPrinted: <?php echo $this->is_printed; ?>
}
</script>
```
6. 新增`HLG.getUrlProtocol`方法，指定填充`link`路径的协议
7. 新增`单元测试`，打单单元测试文件路径：`js_v5/trade/v6/__test`，调整有
```js
// babel.config.js
module.exports = {
    presets: [
        [
            '@babel/preset-env',
            {
                targets:
                {
                    node: 'current',
                },
            },
        ],
    ],
};
```
```json
// package.json
{
    "scripts": {
        "test-trade": "jest js_v5/trade/v6/__test",
    },
    "devDependencies": {
        "babel-jest": "21.0.2",
        "jest": "^26.6.3",
    }
}
```


## 二、Vuex存储全局数据

### 0.入口
> js_v5/trade/v6/vuex/index.js => 将`vuex`存储到`TRADE_STORE`全局变量里
```js
import { get } from '@services/fetch';
import Vue from 'vue';
import Vuex from 'vuex';
import ship from './modules/ship';
import express from './modules/express';
import delivery from './modules/delivery';
import stock from './modules/stock';
import order from './modules/order';
import * as types from './types';
Vue.use(Vuex);

export const getters = {};
export const actions = {};
export const mutations = {};

const vueStore = new Vuex.Store({
    state: {},
    actions,
    mutations,
    modules: {
        ship,
        express,
        delivery,
        order,
        stock,
    },
    strict: process.env.NODE_ENV !== 'production',
});

window.TRADE_STORE = vueStore;
const { _actions: $actions, getters: $getters, state: $state } = TRADE_STORE;
TRADE_STORE.$actions = {};
TRADE_STORE.$getters = $getters;
TRADE_STORE.$state = $state;

Object.keys($actions).map(key => {
    const m = key.match(/(\w+)\/(\w+)/);
    if (!m) {
        TRADE_STORE.$actions[key] = $actions[key][0];
        return;
    }
    TRADE_STORE.$actions[m[1]] = TRADE_STORE.$actions[m[1]] || {};
    TRADE_STORE.$actions[m[1]][m[2]] = $actions[key][0];
});

export default vueStore;
```

### 1.打单公用信息
#### 1-1.获取内购剩余打印次数，以及内购配置信息
    接口：/trade/version/counter
    state字段：
        printCount => 剩余打印次数
        upgradeConfig => 内购配置信息

### 1-2.获取内购版本权限信息
    接口：/trade/version?t=is_restrict
    state字段：
        restrictInfo => 内购权限信息
        noPrintLimit => 是否无打印限制


### 2.快递与快递单模板
#### 2-1.获取可创建的快递列表
    接口：/trade/template?t=expresslist
    state字段：express.expressList => 数组，用于创建时快递列表展示

### 2-2.获取指定快递的一些具体信息: 包含的一联/二联/三联等，以及服务信息
    接口：/trade/template?t=oneexpress
    state字段：暂无

#### 2-3.获取已创建的快递单模板
    接口：/trade/template?t=custome_express
    state字段：
        express.expressTemplates => 数组，全部模板
        express.expressTemplatesWithUsage => 数组，按usage字段排序，用于打印页面模板列表展示
        express.expressTemplatesMap => Map, 以template.id为key
        express.expressTemplatesError => boolean，接口获取失败时使用

#### 2-4.获取所有关联店铺的菜鸟网点信息
    接口：/trade/cainiao?t=user
    state字段：
        express.branches => 数组
        express.branchesMap => Map
        同时修改express.expressTemplates，将branch信息写入

#### 2-5.更新模板
    接口：/trade/template put

### 3.发货地址
#### 3-1.获取发货地址列表
    接口：/trade/address?t=address_list
    state字段：ship.addressList => 数组

#### 3-2.修改某个发货地址
    接口：/trade/address?t=seller_address put

#### 3-3.新增发货地址
    接口：/trade/address?t=seller_address post

#### 3-4.设置默认发货地址
    接口：/trade/config?t=confirmaddress put


### 3.获取发货单模板
    接口：/trade/template?t=invoice
    state字段：delivery.deliveryTemplate => object，发货单模板是唯一的，非数组


### 4.获取备货单模板
    接口：/trade/template?t=itemlist
    state字段：stock.stockTemplate => object，备货单模板是唯一的，非数组


## 三、V6入口
> `js_v5/trade/v6/app.vue` => id="trade-vueapp"
>
> `js_v5/trade/v6/index.js`
>
> `js_v5/trade/index.js`引入`'@trade-v6/index.js'`
```js
// js_v5/trade/v6/index.js
import Vue from 'vue';
import App from './app.vue';
import store from './vuex';

const app = new Vue({
    store,
    mounted() {
        document.dispatchEvent(new Event('render-event'));
    },
    render: r => r(App),
}).$mount('#trade-vueapp');

// window.$store = app.$store;

document.body.appendChild(app.$el);
```


## 四、布局上其他调整
1. 将原来`js_v5/trade/vue-components`里的组件移到`js_v5/trade/v6/components`
2. `js_v5/trade/v6/constants`放常量
3. `js_v5/trade/v6/services`放通用`services`
4. `js_v5/trade/v6/utils`工具库


## 五、打印发货页面

### 选择快递模板下拉菜单重构
![](https://doc.huanleguang.com/download/thumbnails/151722275/20210720163205.jpg?api=v2&nonce=1626769950423)


+ 删除原来的代码，插入`VUE`的组件
```html
<span id="vue-template-selector" ng-non-bindable>
    <express-template-selector @fetch="fetchExpress" @select="selectExpress" />
</span>
```
```js

```
+ 编写`ExpressTemplateSelector`组件，做了什么：
  + 获取快递模板列表，并存入`$state.express`
  + 业务功能：使用`HLGUI`组件，全新UI，新增模板跳转，选择等功能


### 获取发货单模板的逻辑修改
原来写在`model.deliverTemplate`
```js
ExpressTemplatesRes.getDeliveryConfig(result => {
    model.deliveryTemplate = result.config;

    // 已发货的商品不显示删除线
    if (query.status === 'shipped') {
        model.deliveryTemplate.disableLineThrough = true;
    }
});
```
改成通过`vuex`获取与调用

### 校验逻辑封装

+ `checkEmptyItems(items, emptyText)`: 校验是否勾选要打印/联想的订单 => 涉及：
  + 1. 五联单单号联想
  ![](https://doc.huanleguang.com/download/thumbnails/151722275/B63A082D-4FBC-4B2E-BA74-3D780D3F0644.png?api=v2&nonce=1626838168358)
  + 2. 五联单单号联想

+ `checkEmptyTemplate(template, emptyText)`: 校验是否选择模板
  + 1. 五联单单号联想


+ dddddd


### 打印提示弹窗重构
涉及逻辑：
1. 五联单单号联想，先校验是否有特殊订单，或有，则弹窗。并对弹窗后的按钮选择作出对应处理


### printModel的修改

1.删除整个`print-services.js`文件，也没有`printModel`了，`order/index.js`里的`printModel`只是普通的`vm变量`

2.`printModel.sellerInfo`：表示默认发货地址 => 可以不需要设置，可以直接从`template`里取 => 删除；并添加`vm.defaultSellerAddr`存储默认发货地址

3.删除`resend()`方法，与其他打印一起，全部逻辑合成一个`printModel.handlePrint()`

4.`printModel.getSpecialItems`: 获取特殊订单 => `printedOrders`(已打印),`unreachableOrders`(快递不可达),`allRefundOrders`(完全退款)

5.`printModel.printStamp()` 原来是写在`print-services.js`里，作用是更新打印日志 => 只有打印发货列表页面用到 => 移到`order/index.js`中，改到`printModel.updatePrintLog()`
   + 封装`updatePrintLog`方法`更新打印记录`：打印发货中使用；打印完成后，自动弹出联想单号弹窗，关闭弹窗后`更新打印记录`





### 其他修改
1. `vm.express.currTemplate`改成`vm.currTemplate`，由vue组件修改时 或 有默认快递时自动选择 传值过来
2. `vm.express.templatesMap`改成`vm.expressTemplatesMap`
3. 删除`vm.express.templates` => 这边原来是选择快递模板使用的，现在已改成组件，不需要了；=> 删除整个`vm.express`
4. 删除所有原来获取/选择快递模板的代码
5. 将打印前校验的一些弹窗改成`HLGUI`的组件新样式，包含：
   + 校验是否包含锁定订单
6. 打单次数展示组件重构
   ![](https://doc.huanleguang.com/download/thumbnails/151722275/20210721141801.jpg?api=v2&nonce=1626848292419)
7. 对应打印提示弹窗调整 => 使用封装的`showBeforePrint()`方法调用弹窗组件


## 六、自定义打印页面调整

1. 选择发货地址弹窗重构
   ![](https://doc.huanleguang.com/download/thumbnails/151722275/20210721142321.jpg?api=v2&nonce=1626848612649)
2. printModel的修改类似打印发货
3. 将打印完成后的处理放到通用的`printDone`里，`printDone`带`callback`参数，可特殊处理一些情况
4. 对应打印提示弹窗调整 => 使用封装的`showBeforePrint()`方法调用弹窗组件


## 七、底单查询页面调整
1. 对应打印提示弹窗调整 => 使用封装的`showBeforePrint()`方法调用弹窗组件

## 八、其他打印调整
包含：快递单模板、发货单模板、备货单模板的打印测试
打印备货单： /trade/index/index/#/stock/index


## 附录：业务流程图
![](../../.vuepress/public/assets/project/print.png)







